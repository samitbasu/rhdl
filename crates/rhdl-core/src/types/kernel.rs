//! Definition of [Kernel] and [KernelFnKind] types.
//!
//! Not all [Kernel]s are functions defined by the user via a `#[kernel]` attribute.  There are
//! special cases that are generated by RHDL to represent synthesizable constructs that are effectively
//! built in.  For example, when a user kernel calls `bits(n)`, RHDL generates a [Kernel] of kind
//! [KernelFnKind::BitConstructor] to represent that operation.  These are translated into synthesizable
//! code later after type inference is completed and the relevant widths and kinds are known.
use crate::{
    Color, TypedBits,
    ast::ast_impl::{self, WrapOp},
};

/// The different kinds of kernel functions that can be represented in RHDL.
#[derive(Clone, Hash)]
pub enum KernelFnKind {
    /// An AST-defined kernel function (from a user-defined `#[kernel]` function).
    AstKernel(Box<ast_impl::KernelFn>),
    /// A tuple struct constructor
    /// (e.g., for a `struct MyStruct(T1, T2);`).
    TupleStructConstructor(TypedBits),
    /// A bits constructor (e.g., `bits(n)`).
    BitConstructor(usize),
    /// A signed bits constructor (e.g., `signed_bits(n)`).
    SignedBitsConstructor(usize),
    /// An enum tuple struct constructor
    /// (e.g., for a `enum MyEnum { A: T1, B: T2}`).
    EnumTupleStructConstructor(TypedBits),
    /// A signal constructor (e.g., `signal(x)`).
    SignalConstructor(Option<Color>),
    /// A wrap operation for `Result` or `Option`.
    /// E.g., `Ok(x)` or `Some(x)`.
    Wrap(WrapOp),
}

impl std::fmt::Debug for KernelFnKind {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            KernelFnKind::AstKernel(kernel) => {
                write!(
                    f,
                    "kernel {name} {fn_id:?}",
                    name = kernel.name,
                    fn_id = kernel.fn_id
                )
            }
            KernelFnKind::TupleStructConstructor(tb) => {
                write!(f, "tuple struct constructor {tb:?}")
            }
            KernelFnKind::BitConstructor(width) => write!(f, "bit constructor {width}"),
            KernelFnKind::SignedBitsConstructor(width) => {
                write!(f, "signed bits constructor {width}")
            }
            KernelFnKind::EnumTupleStructConstructor(tb) => {
                write!(f, "enum tuple struct constructor {tb:?}")
            }
            KernelFnKind::SignalConstructor(color) => {
                write!(f, "signal constructor {color:?}")
            }
            KernelFnKind::Wrap(op) => write!(f, "wrap {op:?}"),
        }
    }
}
